{% extends "base.html" %}
{% block title %}Cargando Juegos{% endblock %}

{% block content %}
<div class="container text-center mt-5">
    <h2 class="mb-4">Cargando tu biblioteca de Steam...</h2>
    <p class="text-muted">Esto puede tardar unos segundos, por favor espera.</p>

    <!-- Animación de carga -->
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Cargando...</span>
    </div>

    <!-- Barra de progreso -->
    <div class="progress mt-4 mx-auto" style="width: 50%; height: 20px;">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-success" style="width: 0%;">
            0%
        </div>
    </div>

    <p class="mt-3 text-muted" id="status-message">Obteniendo datos de Steam...</p>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        let progress = 0;
        const progressBar = document.getElementById("progress-bar");
        const statusMessage = document.getElementById("status-message");

        // Función para verificar el estado de la descarga
        function checkFetchStatus() {
            fetch(`/api/check_games_status?user_id={{ user_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === "done") {
                        // Redirigir al dashboard cuando la descarga haya terminado
                        window.location.href = "/dashboard";
                    } else if (data.status === "loading") {
                        // Actualizar la barra de progreso y el mensaje de estado
                        progress += 10; // Simulación de progreso (puedes ajustar esto)
                        if (progress > 100) progress = 100;
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                        statusMessage.textContent = `Descargando juegos... (${progress}%)`;

                        // Volver a verificar el estado después de un tiempo
                        setTimeout(checkFetchStatus, 3000); // Reintentar cada 3 segundos
                    }
                })
                .catch(error => {
                    console.error("Error verificando estado de carga:", error);
                    setTimeout(checkFetchStatus, 5000);  // Reintentar en caso de error
                });
        }

        // Iniciar la verificación del estado
        checkFetchStatus();
    });
</script>
{% endblock %}