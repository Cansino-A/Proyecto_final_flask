{% extends "base.html" %}
{% block title %}Tu Biblioteca de Steam{% endblock %}

{% block content %}
<div class="container">
    <h2 class="text-center mt-3">Tu Biblioteca de Steam</h2>
    
    <div id="games-container" class="accordion mt-4">
        <p class="text-center">Cargando juegos...</p>
    </div>

    <!-- Controles de paginaci√≥n -->
    <nav aria-label="Paginaci√≥n">
        <ul class="pagination justify-content-center mt-4" id="pagination-controls"></ul>
    </nav>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    loadGames(1);
});

function loadGames(page) {
    fetch(`/api/games?page=${page}`, {
        method: "GET",
        credentials: "include"  // ‚¨Ö Esto permite enviar la sesi√≥n en la petici√≥n
    })
    .then(response => {
        if (!response.ok) {
            if (response.status === 401) {
                console.error("Sesi√≥n expirada. Redirigiendo a login...");
                window.location.href = "/login";  // ‚¨Ö Redirige al login si la sesi√≥n es inv√°lida
                return;
            }
            throw new Error("Error en la respuesta de la API");
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            console.error("Error de API:", data.error);
            document.getElementById("games-container").innerHTML = `<p class="text-center text-danger">${data.error}</p>`;
            return;
        }

        // Procesar juegos aqu√≠...

    })
    .catch(error => {
        console.error("Error cargando juegos:", error);
        document.getElementById("games-container").innerHTML = `<p class="text-center text-danger">Error al cargar juegos, reintentando...</p>`;

        // ‚ùå Evita reintentar si el usuario no est√° autenticado
        if (!error.message.includes("401")) {
            setTimeout(() => loadGames(page), 5000); // ‚¨Ö Solo reintenta si el error no es 401
        }
    });
}



function loadAchievements(appid) {
    let achievementsList = document.getElementById(`achievements-list-${appid}`);
    achievementsList.innerHTML = "<p class='text-center'>Cargando logros...</p>";

    fetch(`/api/achievements/${appid}`)
        .then(response => response.json())
        .then(data => {
            achievementsList.innerHTML = "";
            
            if (data.error) {
                achievementsList.innerHTML = `<p class="text-danger">${data.error}</p>`;
                return;
            }

            if (data.achievements.length === 0) {
                achievementsList.innerHTML = "<p class='text-muted'>No se han desbloqueado logros en este juego.</p>";
                return;
            }

            data.achievements.forEach(achievement => {
                let achievementHTML = `
                    <li class="list-group-item d-flex align-items-center">
                        <span class="badge bg-success me-2">‚úî</span>
                        <strong>${achievement.name}</strong> - ${achievement.description}
                    </li>
                `;
                achievementsList.innerHTML += achievementHTML;
            });
        })
        .catch(error => {
            achievementsList.innerHTML = `<p class="text-danger">Error al cargar logros.</p>`;
            console.error("Error cargando logros:", error);
        });
}
</script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        checkGames();
    });
    
    let interval = setInterval(checkGames, 5000);  // Verifica cada 5 segundos
    let totalPages = 1; // N√∫mero total de p√°ginas
    
    function checkGames() {
        fetch(`/api/games?page=1`)
            .then(response => response.json())
            .then(data => {
                console.log("üìå Comprobando juegos...", data.games.length);
    
                if (data.games.length > 0) {
                    clearInterval(interval);  // Detiene la verificaci√≥n cuando haya juegos
                    totalPages = data.total_pages;  // Guarda el n√∫mero total de p√°ginas
                    loadGames(1);  // Carga la primera p√°gina inicialmente
                    renderPagination(1, totalPages);
                }
            })
            .catch(error => console.error("üö® Error comprobando juegos:", error));
    }
    
    function loadGames(page) {
    fetch(`/api/games?page=${page}`, {
        method: "GET",
        credentials: "include" // üëà IMPORTANTE: Env√≠a cookies de sesi√≥n
    })
    .then(response => {
        if (response.redirected) {
            window.location.href = response.url;  // Redirige si la API manda un login
        }
        return response.json();
    })
    .then(data => {
        if (data.error) {
            document.getElementById("games-container").innerHTML = `<p class="text-center text-danger">${data.error}</p>`;
            return;
        }

        const container = document.getElementById("games-container");
        const pagination = document.getElementById("pagination-controls");
        container.innerHTML = "";
        pagination.innerHTML = "";

        data.games.forEach(game => {
            const gameHTML = `
                <div class="accordion-item">
                    <h2 class="accordion-header" id="heading${game.appid}">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${game.appid}">
                            <img src="${game.image}" width="100" class="me-3"> 
                            <strong>${game.name}</strong> 
                            <span class="text-muted">(${game.playtime} horas, üèÜ ${game.achieved_count} logros)</span>
                        </button>
                    </h2>
                    <div id="collapse${game.appid}" class="accordion-collapse collapse" data-bs-parent="#games-container">
                        <div class="accordion-body">
                            <button class="btn btn-primary btn-sm" onclick="loadAchievements(${game.appid})">Ver Logros</button>
                            <ul id="achievements-list-${game.appid}" class="list-group mt-3"></ul>
                        </div>
                    </div>
                </div>
            `;
            container.innerHTML += gameHTML;
        });

        // Agregar controles de paginaci√≥n
        if (data.total_pages > 1) {
            if (page > 1) pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadGames(${page - 1})">Anterior</a></li>`;
            for (let p = 1; p <= data.total_pages; p++) {
                pagination.innerHTML += `<li class="page-item ${p === page ? 'active' : ''}"><a class="page-link" href="#" onclick="loadGames(${p})">${p}</a></li>`;
            }
            if (page < data.total_pages) pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadGames(${page + 1})">Siguiente</a></li>`;
        }
    })
    .catch(error => {
        console.error("Error cargando juegos:", error);
        document.getElementById("games-container").innerHTML = `<p class="text-center text-danger">Error al cargar juegos, reintentando...</p>`;
        setTimeout(() => loadGames(page), 5000); // Reintenta despu√©s de 5 segundos
    });
}

    
    function renderPagination(currentPage, totalPages) {
        const pagination = document.getElementById("pagination-controls");
        pagination.innerHTML = "";
    
        if (totalPages > 1) {
            if (currentPage > 1) {
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadGames(${currentPage - 1})">Anterior</a></li>`;
            }
    
            for (let p = 1; p <= totalPages; p++) {
                pagination.innerHTML += `<li class="page-item ${p === currentPage ? 'active' : ''}"><a class="page-link" href="#" onclick="loadGames(${p})">${p}</a></li>`;
            }
    
            if (currentPage < totalPages) {
                pagination.innerHTML += `<li class="page-item"><a class="page-link" href="#" onclick="loadGames(${currentPage + 1})">Siguiente</a></li>`;
            }
        }
    }
    
    function loadAchievements(appid) {
        let achievementsList = document.getElementById(`achievements-list-${appid}`);
        achievementsList.innerHTML = "<p class='text-center'>Cargando logros...</p>";
    
        fetch(`/api/achievements/${appid}`)
            .then(response => response.json())
            .then(data => {
                achievementsList.innerHTML = "";
                
                if (data.error) {
                    achievementsList.innerHTML = `<p class="text-danger">${data.error}</p>`;
                    return;
                }
    
                if (data.achievements.length === 0) {
                    achievementsList.innerHTML = "<p class='text-muted'>No se han desbloqueado logros en este juego.</p>";
                    return;
                }
    
                data.achievements.forEach(achievement => {
                    let achievementHTML = `
                        <li class="list-group-item d-flex align-items-center">
                            <span class="badge bg-success me-2">‚úî</span>
                            <strong>${achievement.name}</strong> - ${achievement.description}
                        </li>
                    `;
                    achievementsList.innerHTML += achievementHTML;
                });
            })
            .catch(error => {
                achievementsList.innerHTML = `<p class="text-danger">Error al cargar logros.</p>`;
                console.error("Error cargando logros:", error);
            });
    }
    </script>
    

{% endblock %}
